{"version":3,"file":"index.js","sources":["../src/client.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-non-null-assertion */\nimport type { WalletConnectModalConfig } from '@walletconnect/modal'\nimport { WalletConnectModal } from '@walletconnect/modal'\nimport SignClient from '@walletconnect/sign-client'\n\n// -- Types ----------------------------------------------------------------\nexport type WalletConnectModalSignSession = SignClient['session']['values'][number]\n\nexport interface WalletConnectModalSignOptions {\n  projectId: string\n  metadata: SignClient['metadata']\n  relayUrl?: string\n  modalOptions?: Omit<WalletConnectModalConfig, 'projectId' | 'walletConnectVersion'>\n}\n\nexport type WalletConnectModalSignConnectArguments = Parameters<SignClient['connect']>[0]\n\nexport type WalletConnectModalSignRequestArguments = Parameters<SignClient['request']>[0]\n\nexport type WalletConnectModalSignDisconnectArguments = Parameters<SignClient['disconnect']>[0]\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type WalletConnectModalEventCallback = (data: any) => void\n\n// -- Client ---------------------------------------------------------------\nexport class WalletConnectModalSign {\n  #options: WalletConnectModalSignOptions\n\n  #modal: WalletConnectModal\n\n  #initSignClientPromise?: Promise<void> = undefined\n\n  #signClient?: InstanceType<typeof SignClient> = undefined\n\n  public constructor(options: WalletConnectModalSignOptions) {\n    this.#options = options\n    this.#modal = this.#initModal()\n    this.#initSignClient()\n  }\n\n  // -- public ------------------------------------------------------------\n  public async connect(args: WalletConnectModalSignConnectArguments) {\n    const { requiredNamespaces, optionalNamespaces } = args\n\n    return new Promise<WalletConnectModalSignSession>(async (resolve, reject) => {\n      await this.#initSignClient()\n\n      const unsubscribeModal = this.#modal.subscribeModal(state => {\n        if (!state.open) {\n          unsubscribeModal()\n          reject(new Error('Modal closed'))\n        }\n      })\n\n      const { uri, approval } = await this.#signClient!.connect(args)\n\n      if (uri) {\n        const namespaceChains = new Set<string>()\n        if (requiredNamespaces) {\n          Object.values(requiredNamespaces).forEach(({ chains }) => {\n            if (chains) {\n              chains.forEach(chain => namespaceChains.add(chain))\n            }\n          })\n        }\n        if (optionalNamespaces) {\n          Object.values(optionalNamespaces).forEach(({ chains }) => {\n            if (chains) {\n              chains.forEach(chain => namespaceChains.add(chain))\n            }\n          })\n        }\n        await this.#modal.openModal({ uri, chains: Array.from(namespaceChains) })\n      }\n\n      try {\n        const session = await approval()\n        resolve(session)\n      } catch (err) {\n        reject(err)\n      } finally {\n        unsubscribeModal()\n        this.#modal.closeModal()\n      }\n    })\n  }\n\n  public async disconnect(args: WalletConnectModalSignDisconnectArguments) {\n    await this.#initSignClient()\n    await this.#signClient!.disconnect(args)\n  }\n\n  public async request<Result>(args: WalletConnectModalSignRequestArguments) {\n    await this.#initSignClient()\n\n    const result = await this.#signClient!.request(args)\n\n    return result as Result\n  }\n\n  public async getSessions() {\n    await this.#initSignClient()\n\n    return this.#signClient!.session.getAll()\n  }\n\n  public async getSession() {\n    await this.#initSignClient()\n\n    return this.#signClient!.session.getAll().at(-1)\n  }\n\n  public async onSessionEvent(callback: WalletConnectModalEventCallback) {\n    await this.#initSignClient()\n    this.#signClient!.on('session_event', callback)\n  }\n\n  public async offSessionEvent(callback: WalletConnectModalEventCallback) {\n    await this.#initSignClient()\n    this.#signClient!.off('session_event', callback)\n  }\n\n  public async onSessionUpdate(callback: WalletConnectModalEventCallback) {\n    await this.#initSignClient()\n    this.#signClient!.on('session_update', callback)\n  }\n\n  public async offSessionUpdate(callback: WalletConnectModalEventCallback) {\n    await this.#initSignClient()\n    this.#signClient!.off('session_update', callback)\n  }\n\n  public async onSessionDelete(callback: WalletConnectModalEventCallback) {\n    await this.#initSignClient()\n    this.#signClient!.on('session_delete', callback)\n  }\n\n  public async offSessionDelete(callback: WalletConnectModalEventCallback) {\n    await this.#initSignClient()\n    this.#signClient!.off('session_delete', callback)\n  }\n\n  public async onSessionExpire(callback: WalletConnectModalEventCallback) {\n    await this.#initSignClient()\n    this.#signClient!.on('session_expire', callback)\n  }\n\n  public async offSessionExpire(callback: WalletConnectModalEventCallback) {\n    await this.#initSignClient()\n    this.#signClient!.off('session_expire', callback)\n  }\n\n  // -- private -----------------------------------------------------------\n  #initModal() {\n    const { modalOptions, projectId } = this.#options\n\n    return new WalletConnectModal({\n      ...modalOptions,\n      projectId\n    })\n  }\n\n  async #initSignClient() {\n    if (this.#signClient) {\n      return true\n    }\n\n    if (!this.#initSignClientPromise && typeof window !== 'undefined') {\n      this.#initSignClientPromise = this.#createSignClient()\n    }\n\n    return this.#initSignClientPromise\n  }\n\n  async #createSignClient() {\n    this.#signClient = await SignClient.init({\n      metadata: this.#options.metadata,\n      projectId: this.#options.projectId,\n      relayUrl: this.#options.relayUrl\n    })\n    const clientId = await this.#signClient.core.crypto.getClientId()\n    try {\n      localStorage.setItem('WCM_WALLETCONNECT_CLIENT_ID', clientId)\n    } catch {\n      console.info('Unable to set client id')\n    }\n  }\n}\n"],"names":["O","j","q","W","P","U","E","n","e","v","x","m","i","r","f","u","s","_options","_modal","_initSignClientPromise","_signClient","_initModal","initModal_fn","_initSignClient","initSignClient_fn","_createSignClient","createSignClient_fn","WalletConnectModalSign","options","__privateAdd","__privateSet","__privateMethod","args","requiredNamespaces","optionalNamespaces","resolve","reject","unsubscribeModal","__privateGet","state","uri","approval","namespaceChains","chains","chain","session","err","callback","modalOptions","projectId","WalletConnectModal","__spreadProps","__spreadValues","SignClient","clientId"],"mappings":"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"}