"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const q=require("events"),l=require("./index-12aaf076.cjs"),m=require("./index-f958f19f.cjs"),b=require("./index-47fbb07d.cjs");require("./index-9c3ad0eb.cjs");require("@cosmjs/encoding");require("@cosmjs/math");require("@cosmjs/proto-signing");require("@cosmjs/stargate");require("long");require("@ethersproject/bignumber");require("@ethersproject/abstract-signer");require("bn.js");require("bchaddrjs");require("bitcoinjs-lib");require("@scure/base");require("crypto");require("buffer");require("util");require("crypto-js");require("elliptic");require("coininfo");require("base64-js");require("./index-282fe8a0.cjs");var g=globalThis&&globalThis.__awaiter||function(a,e,n,t){function o(r){return r instanceof n?r:new n(function(i){i(r)})}return new(n||(n=Promise))(function(r,i){function s(c){try{d(t.next(c))}catch(f){i(f)}}function u(c){try{d(t.throw(c))}catch(f){i(f)}}function d(c){c.done?r(c.value):o(c.value).then(s,u)}d((t=t.apply(a,e||[])).next())})};class v{constructor(){this.exchangeTimeout=3e4,this.unresponsiveTimeout=15e3,this.deviceModel=null,this._events=new q,this.send=(e,n,t,o,r=Buffer.alloc(0),i=[l.StatusCodes.OK])=>g(this,void 0,void 0,function*(){if(r.length>=256)throw new l.TransportError("data.length exceed 256 bytes limit. Got: "+r.length,"DataLengthTooBig");const s=yield this.exchange(Buffer.concat([Buffer.from([e,n,t,o]),Buffer.from([r.length]),r])),u=s.readUInt16BE(s.length-2);if(!i.some(d=>d===u))throw new l.TransportStatusError(u);return s}),this.exchangeAtomicImpl=e=>g(this,void 0,void 0,function*(){if(this.exchangeBusyPromise)throw new l.TransportRaceCondition("An action was already pending on the Ledger device. Please deny or reconnect.");let n;const t=new Promise(i=>{n=i});this.exchangeBusyPromise=t;let o=!1;const r=setTimeout(()=>{o=!0,this.emit("unresponsive")},this.unresponsiveTimeout);try{const i=yield e();return o&&this.emit("responsive"),i}finally{clearTimeout(r),n&&n(),this.exchangeBusyPromise=null}}),this._appAPIlock=null}exchange(e){throw new Error("exchange not implemented")}exchangeBulk(e,n){let t=!1;const o=()=>{t=!0};return(()=>g(this,void 0,void 0,function*(){if(!t)for(const i of e){const s=yield this.exchange(i);if(t)return;const u=s.readUInt16BE(s.length-2);if(u!==l.StatusCodes.OK)throw new l.TransportStatusError(u);n.next(s)}}))().then(()=>!t&&n.complete(),i=>!t&&n.error(i)),{unsubscribe:o}}setScrambleKey(e){}close(){return Promise.resolve()}on(e,n){this._events.on(e,n)}off(e,n){this._events.removeListener(e,n)}emit(e,...n){this._events.emit(e,...n)}setDebugMode(){console.warn("setDebugMode is deprecated. use @ledgerhq/logs instead. No logs are emitted in this anymore.")}setExchangeTimeout(e){this.exchangeTimeout=e}setExchangeUnresponsiveTimeout(e){this.unresponsiveTimeout=e}static create(e=3e3,n){return new Promise((t,o)=>{let r=!1;const i=this.listen({next:u=>{r=!0,i&&i.unsubscribe(),s&&clearTimeout(s),this.open(u.descriptor,e).then(t,o)},error:u=>{s&&clearTimeout(s),o(u)},complete:()=>{s&&clearTimeout(s),r||o(new l.TransportError(this.ErrorMessage_NoDeviceFound,"NoDeviceFound"))}}),s=n?setTimeout(()=>{i.unsubscribe(),o(new l.TransportError(this.ErrorMessage_ListenTimeout,"ListenTimeout"))},n):null})}decorateAppAPIMethods(e,n,t){for(const o of n)e[o]=this.decorateAppAPIMethod(o,e[o],e,t)}decorateAppAPIMethod(e,n,t,o){return(...r)=>g(this,void 0,void 0,function*(){const{_appAPIlock:i}=this;if(i)return Promise.reject(new l.TransportError("Ledger Device is busy (lock "+i+")","TransportLocked"));try{return this._appAPIlock=e,this.setScrambleKey(o),yield n.apply(t,r)}finally{this._appAPIlock=null}})}}v.ErrorMessage_ListenTimeout="No Ledger device found (timeout)";v.ErrorMessage_NoDeviceFound="No Ledger device found";const I=5;function E(a){const e=Buffer.alloc(2);return e.writeUInt16BE(a,0),e}const D={data:Buffer.alloc(0),dataLength:0,sequence:0},_=(a,e)=>({makeBlocks(n){let t=Buffer.concat([E(n.length),n]);const o=e-5,r=Math.ceil(t.length/o);t=Buffer.concat([t,Buffer.alloc(r*o-t.length+1).fill(0)]);const i=[];for(let s=0;s<r;s++){const u=Buffer.alloc(5);u.writeUInt16BE(a,0),u.writeUInt8(I,2),u.writeUInt16BE(s,3);const d=t.slice(s*o,(s+1)*o);i.push(Buffer.concat([u,d]))}return i},reduceResponse(n,t){let{data:o,dataLength:r,sequence:i}=n||D;if(t.readUInt16BE(0)!==a)throw new l.TransportError("Invalid channel","InvalidChannel");if(t.readUInt8(2)!==I)throw new l.TransportError("Invalid tag","InvalidTag");if(t.readUInt16BE(3)!==i)throw new l.TransportError("Invalid sequence","InvalidSequence");n||(r=t.readUInt16BE(5)),i++;const s=t.slice(n?5:7);return o=Buffer.concat([o,s]),o.length>r&&(o=o.slice(0,r)),{data:o,dataLength:r,sequence:i}},getReducedResult(n){if(n&&n.dataLength===n.data.length)return n.data}});var w=globalThis&&globalThis.__awaiter||function(a,e,n,t){function o(r){return r instanceof n?r:new n(function(i){i(r)})}return new(n||(n=Promise))(function(r,i){function s(c){try{d(t.next(c))}catch(f){i(f)}}function u(c){try{d(t.throw(c))}catch(f){i(f)}}function d(c){c.done?r(c.value):o(c.value).then(s,u)}d((t=t.apply(a,e||[])).next())})};const S=[{vendorId:m.ledgerUSBVendorId}];function B(){return w(this,void 0,void 0,function*(){return yield navigator.usb.requestDevice({filters:S})})}function y(){return w(this,void 0,void 0,function*(){return(yield navigator.usb.getDevices()).filter(e=>e.vendorId===m.ledgerUSBVendorId)})}function L(){return w(this,void 0,void 0,function*(){const a=yield y();return a.length>0?a[0]:B()})}const M=()=>Promise.resolve(!!navigator&&!!navigator.usb&&typeof navigator.usb.getDevices=="function");var p=globalThis&&globalThis.__awaiter||function(a,e,n,t){function o(r){return r instanceof n?r:new n(function(i){i(r)})}return new(n||(n=Promise))(function(r,i){function s(c){try{d(t.next(c))}catch(f){i(f)}}function u(c){try{d(t.throw(c))}catch(f){i(f)}}function d(c){c.done?r(c.value):o(c.value).then(s,u)}d((t=t.apply(a,e||[])).next())})};const U=1,T=3;class h extends v{constructor(e,n){super(),this.channel=Math.floor(Math.random()*65535),this.packetSize=64,this._disconnectEmitted=!1,this._emitDisconnect=t=>{this._disconnectEmitted||(this._disconnectEmitted=!0,this.emit("disconnect",t))},this.device=e,this.interfaceNumber=n,this.deviceModel=m.identifyUSBProductId(e.productId)}static request(){return p(this,void 0,void 0,function*(){const e=yield B();return h.open(e)})}static openConnected(){return p(this,void 0,void 0,function*(){const e=yield y();return e.length===0?null:h.open(e[0])})}static open(e){return p(this,void 0,void 0,function*(){yield e.open(),e.configuration===null&&(yield e.selectConfiguration(U)),yield x(e);const n=e.configurations[0].interfaces.find(({alternates:i})=>i.some(s=>s.interfaceClass===255));if(!n)throw new l.TransportInterfaceNotAvailable("No WebUSB interface found for your Ledger device. Please upgrade firmware or contact techsupport.");const t=n.interfaceNumber;try{yield e.claimInterface(t)}catch(i){throw yield e.close(),new l.TransportInterfaceNotAvailable(i.message)}const o=new h(e,t),r=i=>{e===i.device&&(navigator.usb.removeEventListener("disconnect",r),o._emitDisconnect(new l.DisconnectedDevice))};return navigator.usb.addEventListener("disconnect",r),o})}close(){return p(this,void 0,void 0,function*(){yield this.exchangeBusyPromise,yield this.device.releaseInterface(this.interfaceNumber),yield x(this.device),yield this.device.close()})}exchange(e){return p(this,void 0,void 0,function*(){return yield this.exchangeAtomicImpl(()=>p(this,void 0,void 0,function*(){const{channel:t,packetSize:o}=this;b.log("apdu","=> "+e.toString("hex"));const r=_(t,o),i=r.makeBlocks(e);for(let d=0;d<i.length;d++)yield this.device.transferOut(T,i[d]);let s,u;for(;!(s=r.getReducedResult(u));){const d=yield this.device.transferIn(T,o),c=Buffer.from(d.data.buffer);u=r.reduceResponse(u,c)}return b.log("apdu","<= "+s.toString("hex")),s})).catch(t=>{throw t&&t.message&&t.message.includes("disconnected")?(this._emitDisconnect(t),new l.DisconnectedDeviceDuringOperation(t.message)):t})})}setScrambleKey(){}}h.isSupported=M;h.list=y;h.listen=a=>{let e=!1;L().then(t=>{if(!e){const o=m.identifyUSBProductId(t.productId);a.next({type:"add",descriptor:t,deviceModel:o}),a.complete()}},t=>{window.DOMException&&t instanceof window.DOMException&&t.code===18?a.error(new l.TransportWebUSBGestureRequired(t.message)):a.error(new l.TransportOpenUserCancelled(t.message))});function n(){e=!0}return{unsubscribe:n}};function x(a){return p(this,void 0,void 0,function*(){try{yield a.reset()}catch(e){console.warn(e)}})}exports.default=h;
